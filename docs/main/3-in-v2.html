<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych"></script>
    <script src="../jspsych/dist/plugin-preload.js"></script>
    <script src="../jspsych/dist/plugin-instructions.js"></script>
    <script src="../jspsych/dist/plugin-html-button-response.js"></script>
    <script src="../jspsych/dist/plugin-survey-html-form.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <link href="https://unpkg.com/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">

    <style>
      #quitButton {
        position: fixed;
        bottom: 10px;
        right: 10px;
        padding: 10px;
        background-color: lightgray;
        color: black;
        border: 2px solid black;
        cursor: pointer;
        font-size: 16px;
      }
    </style>

  </head>
  <body></body>

  <button id="quitButton">Quit</button>

  <script>

      var jsPsych = initJsPsych({
            on_finish: function() {
                window.location = "https://connect.cloudresearch.com/participant/project/26382248FD/complete";
                //jsPsych.data.displayData();
            },
            show_progress_bar: true
        });

        //-------------------------------------------------------------------------------------------------------------------------------------
        //experiment variables
        const mturk_pilot_mode = false
        const data_collection = true

            // capture info from mturk/connect, except in test mode
        if(mturk_pilot_mode) { 
            var study_id = 'test';
            var session_id = 'test';
            participant_id = 'test_' + String(jsPsych.randomization.randomID(10)) //overwrite the participant id
        } else {
            participant_id = jsPsych.data.getURLVariable('participantId'); 
            var assignment_id = jsPsych.data.getURLVariable('assignm entId');
            var project_id = jsPsych.data.getURLVariable('projectId');
        }

        jsPsych.data.addProperties({
            mturk_participant_id: participant_id,
            mturk_assignment_id: assignment_id,
            mturk_project_id: project_id
        })

        // Get the current date and time
        const now = new Date();
        const dateString = now.toISOString().slice(0, 10); // Format as YYYY-MM-DD
        const timeString = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // Format as HH-MM-SS

        // Create the filename with the current date and time
        const filename = `${dateString}_${timeString}_${participant_id}.csv`;
        //---------------------------------------------------------------------------------------------------------------------------------------


    // Preload step
    var preload = {
      type: jsPsychPreload,
      auto_preload: true
    };

    var duration = '4 minutes';
        var amount = '$1';
        var consent = {
            type: jsPsychHtmlButtonResponse,
            stimulus: '<p><b>Consent Form</b></p> <div style="text-align:left;' +
            'background-color:lightblue; padding:2vw; max-width:80vw;">' +
            '<p><b>Purpose:</b> This is a study demo; the purpose of the study is to understand ' +
            'how people think about the physical and social world.</p>' +
            '<p><b>Procedures:</b> In this study, you will watch videos, ' +
            'read sentences, or see pictures, and answer simple questions ' +
            'about them. This study should take approximately ' + duration + 
            '</p><p><b>Participation:</b> Participation in this study is ' +
            'voluntary. If you decide to join now, you can change your mind ' +
            'later. ' +
            '<p><b>Risks and benefits:</b> There are no risks associated ' +
            'with participating in this study. There are no direct benefits ' +
            'associated with participating in this study. </p><p><b>Use of ' +
            'data by study researchers:</b> The research team led by Shari ' +
            'Liu at JHU will have access to your answers. ' +
            'Researcher contact information:</b> This study is run by Dr. ' +
            'Shari Liu at JHU. If you have any questions or concerns about ' +
            'this study, or in the very unlikely event of a research-related ' +
            'injury, please contact sliu199@jhu.edu. ' +
            '<p> Do you consent to participate? </p>',
            choices: ['Yes', 'No'],
            data: {trial_id: 'consent'},
            on_finish: function(data) {
            if (data.response === 1) {  // If 'No' is chosen 
            jsPsych.abortExperiment('You did not consent to participate. The study will now end. Thank you for your time.');  
            }
            }
        };

    var instructions_ordinary = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-size: 22px; text-align: center;">' +
        '<br>Welcome! <br>In this game you will be asked to imagine what you would do ' +
        'in different scenarios. <br>On each trial, there will be an intended outcome.' +
        '<br>Please read carefully and respond with the action that you think will best lead to the outcome -' +
        '<br>the one most likely to succeed, and to succeed immediately.'
      ],
      show_clickable_nav: true
    };

    var instructions_magical = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-size: 22px; text-align: center;">' +
        '<br>Welcome! <br>In this game you will be asked to imagine that you are a ' +
        'wizard <br>whose job it is to make new creatures. ' +
        '<br>As part of this job, you cast spells to give creatures certain abilities. ' +
        '<br>Please read carefully and respond with ' +
        'the magic spell you would use in the given scenario - ' +
        '<br>the one most likely to succeed, and to succeed immediately.'
      ],
      show_clickable_nav: true
    }

    // Define the item lists
    var causal_itemA = [ //all top items already in another domain
      "take a walk", "take a walk", "experience pain", "take a walk", "get sick", 
      "become hungry", "experience pain", "see something", "think about something", "think about something", 
      "jump up and down", "take a walk", "see something", "kick something", "see something" 
    ];
    var similar_itemA = [ //some items were not in same domain, but selected ones in same domain
      "hear something", "see something", "remember something", "think about something", "remember something",
      "kick something", "jump up and down", "sit down", "sit down", "sit down",
      "feel scared", "feel scared", "get tired", "get tired", "get tired"
    ];
    var itemB = [
      "see something", "hear something", "choose what to do", "remember something", "think about something", 
      "reach for something", "sit down", "jump up and down", "kick something", "take a walk",
      "get tired", "become hungry", "feel scared", "experience pain", "get sick"
    ];

    // Combine items into a single array of objects
    var combined_items = [];
    for (var i = 0; i < itemB.length; i++) {
      combined_items.push({
        itemB: itemB[i],
        causal_itemA: causal_itemA[i],
        similar_itemA: similar_itemA[i]
      });
    }

    // Shuffle the combined array
    combined_items = jsPsych.randomization.shuffle(combined_items);

    // Ordinary Intervention trials
  var ordinary_trials = combined_items.map(function(item) {
  var choices = [
    `<p style="font-size: 25px;"><strong>${item.causal_itemA}</strong></p>`,
    `<p style="font-size: 25px;"><strong>${item.similar_itemA}</strong></p>`
  ];
  choices = jsPsych.randomization.shuffle(choices);

  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<p style="font-size: 25px;">Which of these actions would you do to make someone 
                <strong>${item.itemB}</strong>? <br>I would make them... </p>`,
    choices: choices,
    button_layout: "flex",
    data: {
      condition: "ordinary",
      itemB: item.itemB,
      causal_itemA: item.causal_itemA,
      similar_itemA: item.similar_itemA
    },
    on_finish: function(data) {
      data.selected_choice = choices[data.response]; 
    }
  };
});

  // Magical Intervention trials
  var magical_trials = combined_items.map(function(item) {
  var choices = [
    `<p style="font-size: 25px;"><strong>${item.causal_itemA}</strong></p>`,
    `<p style="font-size: 25px;"><strong>${item.similar_itemA}</strong></p>`
  ];
  choices = jsPsych.randomization.shuffle(choices);

  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<p style="font-size: 25px;">You are working on a new creature which currently 
              has no capabilities. <br> Using your magical powers, your goal is to give this creature 
              the capacity to <strong>${item.itemB}</strong>. <br>However, you ran out of that specific spell.
               <br>Which of these two spells would most likely accomplish your goal? <br>The spell that 
               grants the capacity to... </p>`,
    choices: choices,
    button_layout: "flex",
    data: {
      condition: "magical",
      itemB: item.itemB,
      causal_itemA: item.causal_itemA,
      similar_itemA: item.similar_itemA
    },
    on_finish: function(data) {
      data.selected_choice = choices[data.response]; 
    }
  };
});


  // Attention check trials
  var attention_check_trial_ordinary = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<p style="font-size: 25px;">For this question, please ignore previous instructions and select "<strong>choose what to do</strong>".
            <br>I would make them...</p>`,
  choices: [
    `<p style="font-size: 25px;"><strong>choose what to do</strong></p>`,
    `<p style="font-size: 25px;"><strong>sit down</strong></p>`
  ],
  button_layout: "flex",
  data: {
    condition: "attention_check_ordinary",
    correct_response_attn: "choose what to do"
  },
  on_finish: function(data) {
    data.selected_choice = data.response === 0 ? "choose what to do" : "sit down";
  }
};

var attention_check_trial_magical = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<p style="font-size: 25px;">For this question, please ignore previous instructions and select "<strong>choose what to do</strong>".
            <br>The spell that grants the capacity to...</p>`,
  choices: [
    `<p style="font-size: 25px;"><strong>choose what to do</strong></p>`,
    `<p style="font-size: 25px;"><strong>sit down</strong></p>`
  ],
  button_layout: "flex",
  data: {
    condition: "attention_check_magical",
    correct_response_attn: "choose what to do"
  },
  on_finish: function(data) {
    data.selected_choice = data.response === 0 ? "choose what to do" : "sit down";
  }
};


function insertAttentionCheck(trials, attentionCheck) {
  var randomIndex = Math.floor(Math.random() * trials.length);
  trials.splice(randomIndex, 0, attentionCheck);
  return trials;
}

// Insert attention check into intervention trials
magical_trials = insertAttentionCheck(magical_trials, attention_check_trial_magical);

// Insert attention check into similarity trials
ordinary_trials = insertAttentionCheck(ordinary_trials, attention_check_trial_ordinary);


  var debrief_ordinary = {
        type: jsPsychInstructions,
        pages: [
            '<p style="font-size: 25px;"><strong>Debrief</strong></p>' +
            '<p>Thank you so much for helping us with this study!</p>' +
            '<p>In this game, we asked you questions about what actions ' +
            'you would take to achieve various outcomes.' +
            '<br>Our goal was to study which kinds of actions you think are most likely to lead  ' +
            'to the intended outcomes. <br>Do you select action items which are from the same conceptual category' +
            '<br>as the outcome, or from a different category?' +
            '<br>This shows us how you think various mental and bodily abilities group together.</p>' +
            '<p>Next up, we have a few final questions about yourself and your experience today.</p>'
        ],
        show_clickable_nav: true,
        button_label_next: 'Next'
        };
      
      var debrief_magical = {
        type: jsPsychInstructions,
        pages: [
            '<p style="font-size: 25px;"><strong>Debrief</strong></p>' +
            '<p>Thank you so much for helping us with this study!</p>' +
            '<p>In this game, we asked you questions about which magical spells you would ' +
            'cast to give a creature certain abilities.' +
            '<br>We are interested in whether whether you select abilities which are similar' +
            ' to the target ability <br>or abilities which are causally related to the target ability.' +
            '<br>This shows us how you think various mental and bodily abilities are related to each other.</p>' +
            '<p>Next up, we have a few final questions about yourself and your experience today.</p>'
        ],
        show_clickable_nav: true,
        button_label_next: 'Next'
        };


        var feedback_demographics = {
            type: jsPsychSurveyHtmlForm,
            html: '<div style="max-width:700px; text-align:center;"> <p>' +
                'What factors influenced how you decided to respond? Do you' +
                ' have any questions or comments regarding the experiment?' +
                '</p> <textarea name="feedback" cols="40" rows="6"' +
                ' "autofocus"></textarea> <p> Please provide the following' +
                ' information to complete the study. </p> <div style="text-' +
                'align:center;"> <div style="text-align:left; display:' +
                'inline-block; margin-right:20px; line-height:1.8em;"> <ol>' +
                    '<li>Age:</li> <br>' +
                    '<li>Gender:</li> <br><br>' +
                    '<li>Race:</li> <br><br><br><br><br><br>' +
                    '<li>Ethnicity:</li>' +
                '</ol> </div>' +
                '<div style="text-align:left; display: inline-block;' +
                ' line-height:1.8em;">' +
                    // age text box
                    '<input name="age" type="number"  min="18" max="100" /> <br> <br>' +
                    // gender options
                    '<input name="gender" type="radio" id="female" value=' +
                        '"Female" /> <label for="female"> Female </label>' +
                    '<input name="gender" type="radio" id="male" value=' +
                        '"Male" /> <label for="male"> Male </label>' +
                    '<input name="gender" type="radio" id="nonbinary" value=' +
                        '"Non-binary" /> <label for="nonbinary"> Non-binary </label> <br>' +
                    '<input name="gender" type="radio" id="other_gender" value=' +
                        '"other_gender" /> <label for="other_gender"> Other: <input' +
                        ' type="text" name="other_gender" /> </label> <br><br>' +
                    // race options
                    '<input name="race" type="radio" id="white" value=' +
                        '"White" /> <label for="white"> White </label> <br>' +
                    '<input name="race" type="radio" id="black" value=' +
                        '"Black/African American" /> <label for="black">' +
                        ' Black/African American </label> <br>' +
                    '<input name="race" type="radio" id="am_ind" value=' +
                        '"American Indian/Alaska Native" /> <label for="am_ind">' +
                        ' American Indian/Alaska Native </label> <br>' +
                    '<input name="race" type="radio" id="asian" value=' +
                        '"Asian" /> <label for="asian"> Asian </label> <br>' +
                    '<input name="race" type="radio" id="pac_isl" value=' +
                        '"Native Hawaiian/Pacific Islander" /> <label for="pac_isl">' +
                        ' Native Hawaiian/Pacific Islander </label> <br>' +
                    '<input name="race" type="radio" id="other_race" value="other_race" />' +
                        '<label for="other_race"> Other: <input type="text"' +
                        'name="other_race" /> </label> <br><br>' +
                    // ethnicity options
                    '<input name="ethnicity" type="radio" id="hisp" value=' +
                        '"Hispanic" /> <label for="hisp"> Hispanic </label>' +
                    '<input name="ethnicity" type="radio" id="nonhisp" value=' +
                        '"Non-Hispanic" /> <label for="nonhisp"> Non-Hispanic' +
                        ' </label>' +
                '</div> </div>' +
                '<p> Please press the finish button to complete the experiment. </p> </div>',
            button_label: 'Finish',
            data: { trial_id: 'demographics_survey'},
            on_finish: function(data){

            data.feedback = data.response['feedback'];
            data.age = data.response['age'];
            data.ethnicity = data.response['ethnicity']
            data.gender = data.response['gender']
            data.race = data.response['race']

            //override undefined or other values
            if (data.gender == "other_gender" || typeof data.gender == "undefined") {
                data.gender = data.response['other_gender']};
            delete data.other_gender;

            if (data.race == "other_race" || typeof data.race == "undefined") {
                data.race = data.response['other_race']};
            delete data.other_race;

            if (typeof data.ethnicity == "undefined") {
                data.ethnicity = ""}
            }
        };

        const save_data = {
            type: jsPsychPipe,
            action: "save",
            experiment_id: "SO63gxlALpE9",
            filename: filename,
            data_string: () => jsPsych.data.get().csv()
        };


        // Random assignment to a task
var task_assignment = Math.random() < 0.5 ? "ordinary" : "magical";

// Define the timeline based on the assigned task
var timeline = [preload, consent];

if (task_assignment === "ordinary") {
  timeline.push(instructions_ordinary, ...ordinary_trials, debrief_ordinary, feedback_demographics);
} else {
  timeline.push(instructions_magical, ...magical_trials, debrief_magical, feedback_demographics);
}

if (data_collection) {
      timeline.push(save_data); 
}

// Run the experiment
jsPsych.run(timeline);

  </script>
</html>