<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="jspsych/dist/plugin-survey-html-form.js"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-survey-slider@1.0.0"></script>
    <link href="https://unpkg.com/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">

    <style>
      #quitButton {
        position: fixed;
        bottom: 10px;
        right: 10px;
        padding: 10px;
        background-color: lightgray;
        color: black;
        border: 2px solid black;
        cursor: pointer;
        font-size: 16px;
      }
    </style>

  </head>
  <body></body>

  <button id="quitButton">Quit</button>

  <script>

      var jsPsych = initJsPsych({
            on_finish: function() {
                window.location = "https://connect.cloudresearch.com/participant/project/9CECB6EE85/complete";
                //jsPsych.data.displayData();
            },
            show_progress_bar: true
        });

        //experiment variables
        const mturk_pilot_mode = false
        const data_collection = true

            // capture info from mturk/connect, except in test mode
        if(mturk_pilot_mode) { 
            var study_id = 'test';
            var session_id = 'test';
            participant_id = 'test_' + String(jsPsych.randomization.randomID(10)) //overwrite the participant id
        } else {
            participant_id = jsPsych.data.getURLVariable('participantId'); 
            var assignment_id = jsPsych.data.getURLVariable('assignm entId');
            var project_id = jsPsych.data.getURLVariable('projectId');
        }

        jsPsych.data.addProperties({
            mturk_participant_id: participant_id,
            mturk_assignment_id: assignment_id,
            mturk_project_id: project_id
        })

        // Get the current date and time
        const now = new Date();
        const dateString = now.toISOString().slice(0, 10); // Format as YYYY-MM-DD
        const timeString = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // Format as HH-MM-SS

        // Create the filename with the current date and time
        const filename = `${dateString}_${timeString}_${participant_id}.csv`;
        //---------------------------------------------------------------------------------------------------------------------------------------


    // Preload step
    var preload = {
      type: jsPsychPreload,
      auto_preload: true
    };

    var instructions_explanation = {
      type: jsPsychInstructions,
      pages: [
        '<div style="font-size: 22px; text-align: center;">' +
        '<br>Welcome! <br>In this game you will be asked to consider different explanations ' +
        'for an event. <br>You will be presented with a target event (i.e. someone reached for something)' +
        ' and asked to evaluate <br>how well two other events explains the target event (i.e. the person saw something, or the person got tired). '
      ],
      show_clickable_nav: true
    };

    // Define the item lists
    var causal_itemA = [ //all top items already in another domain
      "take a walk", "take a walk", "feel scared", "take a walk", "take a walk", 
      "become hungry", "experience pain", "think about something", "think about something", "think about something", 
      "jump up and down", "take a walk", "see something", "kick something", "see something" 
    ];

    var causal_itemA_past_tense = [ //all top items already in another domain
      "took a walk", "took a walk", "felt scared", "took a walk", "took a walk", 
      "became hungry", "experienced pain", "thought about something", "thought about something", "thought about something", 
      "jumped up and down", "took a walk", "saw something", "kicked something", "saw something" 
    ];

    var similarity_itemA = [ //some items were not in same domain, but selected ones in same domain
      "hear something", "see something", "remember something", "think about something", "remember something",
      "kick something", "jump up and down", "sit down", "jump up and down", "jump up and down",
      "feel scared", "experience pain", "become hungry", "feel scared", "get tired"
    ];

    var similarity_itemA_past_tense = [ //some items were not in same domain, but selected ones in same domain
      "heard something", "saw something", "remembered something", "thought about something", "remembered something",
      "kicked something", "jumped up and down", "sat down", "jumped up and down", "jumped up and down",
      "felt scared", "experienced pain", "became hungry", "felt scared", "got tired"
    ];

    var itemB = [
      "see something", "hear something", "choose what to do", "remember something", "think about something", 
      "reach for something", "sit down", "jump up and down", "kick something", "take a walk",
      "get tired", "become hungry", "feel scared", "experience pain", "get sick"
    ];

    var itemB_past_tense = [
      "saw something", "heard something", "chose what to do", "remembered something", "thought about something", 
      "reached for something", "sat down", "jumped up and down", "kicked something", "took a walk",
      "got tired", "became hungry", "felt scared", "experienced pain", "got sick"
    ];

    const slider_labels = ['Definitely not', 'Maybe not', 'Unsure', 'Maybe yes', 'Definitely yes'];

    // Combine items into a single array of objects
    var combined_items = [];
    for (var i = 0; i < itemB.length; i++) {
      combined_items.push({
        itemB: itemB[i],
        itemB_past_tense: itemB_past_tense[i],
        causal_itemA: causal_itemA[i],
        causal_itemA_past_tense: causal_itemA_past_tense[i],
        similarity_itemA: similarity_itemA[i],
        similarity_itemA_past_tense: similarity_itemA_past_tense[i],

      });
    }

    // Shuffle the combined array
    combined_items = jsPsych.randomization.shuffle(combined_items);

//-----------------------------------
// Causal counterfactuals study trials (using correct tense)
// var explanation_trials = combined_items.map(function(item, index) {
//   return {
//     type: jsPsychHtmlSliderResponse,
//     stimulus: `<p style="font-size: 25px;">Suppose that someone <strong>${item.itemB_past_tense}</strong>.
//                <br>To what extent is the following a good explanation for why the person <strong>${item.itemB_past_tense}</strong>?</p>
//                <p style="font-size: 25px;">Because they <strong>${item.causal_itemA_past_tense}</strong></p>`,
//     labels: slider_labels,
//     slider_width: 600,
//     require_movement: true, 
//     data: {
//       condition: "counterfactual",
//       itemB: item.itemB,
//       causal_itemA: item.causal_itemA
//     },
//     on_finish: function(data) {
//       data.response_value = data.response; 
//     }
//   };
// });

//-------------------------------------

// Explanation study trials with two sliders per trial
var explanation_trials = combined_items.map(function(item) {
  return {
    type: jsPsychSurveySlider, // Use survey-slider to allow multiple sliders in one trial 
    preamble: `<p style="font-size: 25px;">Suppose that someone <strong>${item.itemB_past_tense}</strong>.</p>
               <p style="font-size: 25px;">Which of the following be a good explanation for why the person <strong>${item.itemB_past_tense}</strong>?</p>`,
    questions: [
      {
        prompt: `<hr style="border: 1px solid #ccc; margin-bottom: 10px;">
                <p style="font-size: 24px;">Because they <strong>${item.causal_itemA_past_tense}</strong></p>`,
        ticks: slider_labels
      },
      {
        prompt: `<hr style="border: 1px solid #ccc; margin-bottom: 10px;">
                <p style="font-size: 24px;">Because they <strong>${item.similarity_itemA_past_tense}</strong></p>`,
        ticks: slider_labels
      }
    ],
    slider_width: 600,
    require_movement: true,
    data: {
      condition: "explanation",
      itemB_past_tense: item.itemB_past_tense,
      causal_itemA_past_tense: item.causal_itemA_past_tense,
      similarity_itemA_past_tense: item.similarity_itemA_past_tense
    }
  };
});


//-------------------------------------------------
// Explanation study trials with two sliders per trial
var attention_check_trial_explanation_main = combined_items.map(function(item) {
  return {
    type: jsPsychSurveySlider, // Use survey-slider to allow multiple sliders in one trial 
    preamble: `<p style="font-size: 25px;">For this question, please move both sliders to "definitely not"</strong></p>`,
    questions: [
      {
        prompt: `<hr style="border: 1px solid #ccc; margin-bottom: 10px;">
                <p style="font-size: 24px;">Because they <strong>Chose what to do</strong></p>`,
        ticks: slider_labels
      },
      {
        prompt: `<hr style="border: 1px solid #ccc; margin-bottom: 10px;">
                <p style="font-size: 24px;">Because they <strong>Remembered something</strong></p>`,
        ticks: slider_labels
      }
    ],
    slider_width: 600,
    require_movement: true,
    data: {
      condition: "attention_check",
      correct_response_attn: "0"
    }
  };
});
//--------------------------------------------------------------------

  // Attention check trials
  var attention_check_trial_explanation = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `<p style="font-size: 25px;">For this question, please select "Because they <strong>"chose what to do"</strong>"</p>`,
  choices: [
    `<p style="font-size: 24px;">Because they <strong>chose what to do</strong></p>`,
    `<p style="font-size: 24px;">Because they <strong>sat down</strong></p>`
  ],
  button_layout: "flex",
  data: {
    condition: "attention_check",
    correct_response_attn: "choose what to do"
  },
  on_finish: function(data) {
    data.selected_choice = data.response === 0 ? "I would make them choose what to do" : "I would make them sit down";
  }
};

function insertAttentionCheck(trials, attentionCheck) {
  var randomIndex = Math.floor(Math.random() * trials.length);
  trials.splice(randomIndex, 0, attentionCheck);
  return trials;
}

// Insert attention check into intervention trials
intervention_trials = insertAttentionCheck(explanation_trials, attention_check_trial_explanation_main);

//to update!
  var debrief_explanation = {
        type: jsPsychInstructions,
        pages: [
            '<p style="font-size: 24px;"><strong>Debrief</strong></p>' +
            '<p>Thank you so much for helping us with this study!</p>' +
            '<p>In this game, we asked you questions about what actions ' +
            'you would take to achieve various outcomes.' +
            '<br>Our goal was to study which kinds of actions you think are most likely to lead  ' +
            'to the intended outcomes. <br>Do you select action items which are from the same conceptual category' +
            '<br>as the outcome, or from a different category?' +
            '<br>This shows us how you think various mental and bodily abilities group together.</p>' +
            '<p>Next up, we have a few final questions about yourself and your experience today.</p>'
        ],
        show_clickable_nav: true,
        button_label_next: 'Next'
        };

        const save_data = {
            type: jsPsychPipe,
            action: "save",
            experiment_id: "SO63gxlALpE9",
            filename: filename,
            data_string: () => jsPsych.data.get().csv()
        };


        // Random assignment to a task
var task_assignment = Math.random() < 0.5 ? "intervention" : "similarity";

// Define the timeline based on the assigned task
var timeline = [preload];

timeline.push(instructions_explanation, ...explanation_trials, debrief_explanation);

if (data_collection) {
      timeline.push(save_data); 
}

// Run the experiment
jsPsych.run(timeline);

  </script>
</html>